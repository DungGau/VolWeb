{% extends "dashboard/base.html" %}
{% load static %}
{% block content%}
<!-- Custom Card Style -->
<style type="text/css">
  .main {
    color:#ffffff;
    --tw-bg-opacity: 1;
    font-family: Anonymous Pro, monospace;
    --tw-text-opacity: 1;
    color: rgba(233, 233, 233, var(--tw-text-opacity));
    -moz-osx-font-smoothing: grayscale;
    -moz-osx-font-smoothing: auto;
    font-size: 0.9rem;
  }
  .modal-content {
    background-color: #293b58;
  }
  .card{
    border-width: small;
    background-color:#293b58;
    transition: .3s transform cubic-bezier(.155,1.105,.295,1.12),.3s box-shadow,.3s -webkit-transform cubic-bezier(.155,1.105,.295,1.12);
    padding: 14px 30px 10px 30px;
  }

  .card:hover{
    transform: scale(1.01);
  }

  .text-white {
    --tw-bg-opacity: 1;
    font-family: Anonymous Pro, monospace;
    --tw-text-opacity: 1;
    color: rgba(233, 233, 233, var(--tw-text-opacity));
    -moz-osx-font-smoothing: grayscale;
    -moz-osx-font-smoothing: auto;
    font-size: 0.9rem;
  }
  .query-input {
    background-color:#293b58;
    font-size: 1rem;
    line-height: 3rem;
    width: 100%;
    white-space: nowrap;
    color:#ffffff;
  }

  .h3 {
    color: #eb1f5a;
    float:right;
  }

  .invests:hover{
    color:#ffffff;
  }
</style>
<div class="container-fluid main" style="overflow-y:scroll">
  <div class="row">
    <div class="col-12">
      <h1 class="h3">Investigations</h1>
      <div class="d-inline">
				<input class="query-input form-control mb-3" id="myInput" type="text" placeholder="Search..">
			</div>
      <p><a href="{%url 'newinvest'%}">Create a new investigation.</a></p>
      <hr>
    </div>
  </div>
  <div class="row">
    <div class="col-12">
      <!-- Investigations Cards -->
      <div id="cards" class="card-deck">
        {% if investigations %}
        {% for i in investigations %}
        <a href="#" class="invests" data-bs-toggle="modal" data-bs-target="#card_{{i.id}}" id="card_{{i.title}}" style="text-decoration:none">
          <div class="card mb-3 flex-row justify-content-center align-items-center shadow rounded">
            <div class="card-header border-0 ">
              <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" fill="currentColor" class="bi bi-windows" viewBox="0 0 16 16">
                <path d="M6.555 1.375 0 2.237v5.45h6.555V1.375zM0 13.795l6.555.933V8.313H0v5.482zm7.278-5.4.026 6.378L16 16V8.395H7.278zM16 0 7.33 1.244v6.414H16V0z"/>
              </svg>
            </div>
            <div class="card-body">
              <p class="card-subtitle h4 mb-2" style="color:#32d3bc;" id="invest-title">{{ i.title }}</p>
              <p class="card-subtitle mb-2" id="invest-description" >{{ i.description }}</p>
              <small><u>Forensics Expert(s)</u> : {{ i.investigators }}</small>
              <hr>
              {% if i.status == "0" %}
              <p class="card-subtitle" style="color:#eb1f5a;" id="invest-status_{{i.id}}">Not Analysed.</p>
              {% endif  %}
              {% if i.status == "1" %}
              <div style="float:left; color:#dea71d; margin-right:5px;" class="spinner-grow spinner-grow-sm" role="status"></div><p class="card-subtitle" style=" color:#dea71d;" id="invest-status_{{i.id}}">Investigation in progress </p>
              {% endif %}

              {% if i.status == "2" %}
              <p class="card-subtitle" id="invest-status_{{i.id}}" style="color:#32d3bc;">Ready to be reviewed</p>
              {% endif %}
            </div>
          </div>
        </a>

        <!-- Modal displayed for each investigations -->
        <div class="text-white modal fade" id="card_{{i.id}}" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
          <div class="modal-dialog border">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Investigation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <ul>
                  <li>Title : {{i.title}}</li>
                  <li>OS Version : {{i.os_version}}</li>
                  <li>Forensics Expert(s): {{i.investigators}}</li>
                  <li>File: {{i.name}}</li>
                </ul>
                {% if i.status == "0" %}
                This memory sample is not analysed yet.
                {% endif %}
                {% if i.status == "1" %}
                This sample is being analysed. Please Wait.
                {% endif %}
                {% if i.status == "2" %}
                This sample is ready to be reviewed.
                {% endif %}
              </div>
              <div class="modal-footer">
                {% if i.status == "0" %}
                  <button class="btn btn-prim" onclick="StartAnalysis('{{i.id}}');" data-bs-dismiss="modal">Start analysis</button>
                {% endif %}
                {% if i.status == "1" %}
                  <button type="button" class="btn btn-warn" onclick="CancelAnalysis('{{i.id}}');" data-bs-dismiss="modal">Cancel analysis</button>
                {% endif %}
                {% if i.status == "2" %}
                <form id="reviewform" action="{% url 'reviewinvest' %}" method="GET">
                  <input type="hidden" name="sa_case_id" value="{{i.id}}">
                  <input class="btn btn-succ" type="submit" value="Review results">
                </form>
                  <button type="button" class="btn btn-prim" onclick="StartAnalysis('{{i.id}}');" data-bs-dismiss="modal">Restart analysis</button>
                {% endif %}
                <button type="button" class="btn btn-dang" onclick="DeleteAnalysis('{{i.id}}')" data-bs-dismiss="modal">Delete</button>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
        <form method="POST">
          {% csrf_token %}
          {{form.sa_case_id}}
        </form>
        {% endif %}
      </div>
    </div>

  </div>
</div>
{% include "investigations/toasts.html" %}

<!-- Ajax post requests management (Create/Delete/Restart/Cancel) -->
<script
      src="https://code.jquery.com/jquery-3.6.0.min.js"
      integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
      crossorigin="anonymous"></script>


<script>
  function StartAnalysis(case_id){
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const fd = new FormData();
    fd.append('csrfmiddlewaretoken', csrftoken);
    fd.append('sa_case_id', case_id);
    $.ajax({
      type:'POST',
      url: "{% url 'start_analysis' %}",
      enctype: 'multipart/form-data',
      data: fd,
      beforeSend: function(){
        //Toggle the message that we did take the request into a count
      },
      success: function(response){
        if (response['message'] == "success") {
          $('#proc-success-message').html("Starting analysis...");
          $('.toast-proc-success').toast('show');
          refresh();
        }
        if (response['message'] == "error")
        {
          $('#proc-error-message').html("Invalid request");
          $('.toast-proc-error').toast('show');
        }
      },
      error: function(error){
        $('#proc-error-message').html("Something went wrong (500) ");
        $('.toast-proc-error').toast('show');
      },
      cache: false,
      contentType : false,
      processData: false
    });
  }

  /* Delete investigation script */
  function CancelAnalysis(case_id){
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const fd = new FormData();
    fd.append('csrfmiddlewaretoken', csrftoken);
    fd.append('sa_case_id', case_id);
    $.ajax({
      type:'POST',
      url: "{% url 'cancel_analysis' %}",
      enctype: 'multipart/form-data',
      data: fd,
      beforeSend: function(){
        //Toggle the message that we did take the request into a count
      },
      success: function(response){
        if (response['message'] == "success") {
          $('#proc-success-message').html("Analysis canceled.");
          $('.toast-proc-success').toast('show');
          refresh();
        }
        if (response['message'] == "error")
        {
          $('#proc-error-message').html("Invalid request");
          $('.toast-proc-error').toast('show');
        }
      },
      error: function(error){
        $('#proc-error-message').html("Something went wrong (500) ");
        $('.toast-proc-error').toast('show');
      },
      cache: false,
      contentType : false,
      processData: false
    });
  }

  /* Review Analysis script */
  function ReviewCase(id){
    const csrf = document.getElementsByName('csrfmiddlewaretoken');
    const action = document.getElementById('id_action');
    const case_id = document.getElementById('id_id');
    action.value = "3";
    case_id.value = id;
  }
  /* Delete investigation script */
  function DeleteAnalysis(case_id){
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const fd = new FormData();
    fd.append('csrfmiddlewaretoken', csrftoken);
    fd.append('sa_case_id', case_id);
    $.ajax({
      type:'POST',
      url: "{% url 'remove_analysis' %}",
      enctype: 'multipart/form-data',
      data: fd,
      beforeSend: function(){
        //Toggle the message that we did take the request into a count
      },
      success: function(response){
        if (response['message'] == "success") {
          $('#proc-success-message').html("Analysis removed.");
          $('.toast-proc-success').toast('show');
          refresh();
        }
        if (response['message'] == "error")
        {
          $('#proc-error-message').html("Invalid request");
          $('.toast-proc-error').toast('show');
        }
      },
      error: function(error){
        $('#proc-error-message').html("Something went wrong (500) ");
        $('.toast-proc-error').toast('show');
      },
      cache: false,
      contentType : false,
      processData: false
    });
  }

  // Refresh or reload page.
  function refresh() {
    $.ajax({
      url: "{% url 'investigations' %}",
      success: function(data) {
        var parser = new DOMParser();
        var wrapper = parser.parseFromString(data, "text/html");
        cards = wrapper.getElementById('cards');
        $('#cards').html(cards);
      }
    });
  }
  //Search an investigation
  $(document).ready(function(){
    $("#myInput").on("keyup", function() {
      var value = $(this).val().toLowerCase();
      $("#cards a").filter(function() {
        $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
      });
    });
    window.setInterval('refresh()', 30000); 	// Call a function every 10000 milliseconds (OR 10 seconds).
  });
</script>
{% endblock content %}
